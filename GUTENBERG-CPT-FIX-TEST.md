# Gutenberg右サイドバー作業メモCPT自動生成機能 動作確認メモ

## 実装内容
- `save_post_post` / `save_post_page` フックで投稿/固定ページ保存時にメタデータから作業メモCPTを自動生成
- 重複防止のためのハッシュ機能
- Gutenberg UI現状維持

## テスト環境
- WordPress: Gutenbergエディタ有効
- プラグイン: work-notes (修正版)

## テストケース1: Gutenberg新規投稿での作業メモCPT生成

### 手順
1. **新規投稿作成**
   - WordPress管理画面 > 投稿 > 新規追加
   - 任意のタイトル・本文を入力

2. **右サイドバーで作業メモ入力**
   - 右サイドバー「作業メモ属性」を展開
   - 以下の項目を入力：
     - 依頼元: 「テスト依頼元」
     - 担当者: 「テスト担当者」
     - ステータス: 「対応中」

3. **投稿を保存**
   - 「公開」または「下書き保存」をクリック

### 期待結果
- [ ] 投稿が正常保存される
- [ ] 「作業メモ」→「すべての作業メモ」に新しいメモが追加される
- [ ] タイトル: 「作業メモ YYYY-MM-DD HH:MM」形式
- [ ] 内容: 投稿タイトルと入力した項目が含まれる
- [ ] ステータス: 「公開済み」

## テストケース2: 既存投稿での作業メモ更新

### 手順
1. **既存投稿を編集**
   - 既存の投稿を開く
   - 右サイドバーで作業メモ項目を変更
   - 例：ステータスを「依頼」→「完了」に変更

2. **投稿を更新**
   - 「更新」ボタンをクリック

### 期待結果
- [ ] 新しい作業メモCPTが追加される（既存と併存）
- [ ] 変更された内容が新しいメモに反映される

## テストケース3: 重複防止テスト

### 手順
1. **投稿を連続保存**
   - 作業メモ入力後、「更新」を複数回クリック
   - 内容を変更せずに保存を繰り返す

### 期待結果
- [ ] 作業メモCPTは1つのみ作成される（重複しない）
- [ ] 同じハッシュでの重複作成が防止される

## テストケース4: 空フィールドでの非作成

### 手順
1. **空の作業メモ状態で保存**
   - 右サイドバーの作業メモ項目を全て空にする
   - 投稿を保存

### 期待結果
- [ ] 作業メモCPTは作成されない
- [ ] 既存機能に影響しない

## テストケース5: Classic Editorとの併存

### 手順
1. **Classic Editorプラグインを有効化**
   - 同じ投稿をClassic Editorで開く
   - 作業メモメタボックスから作業メモを入力
   - 保存

### 期待結果
- [ ] Classic Editorの作業メモ機能が正常動作
- [ ] Gutenberg機能と重複せず併存

## テストケース6: 固定ページでの動作確認

### 手順
1. **新規固定ページ作成**
   - 固定ページで同様の作業メモ入力・保存を実行

### 期待結果
- [ ] 投稿と同様に作業メモCPTが生成される

## 確認すべきメタデータ

### 作成された作業メモCPTの確認項目
- [ ] `_ofwn_target_type`: 'post' または 'page'
- [ ] `_ofwn_target_id`: 元投稿/固定ページのID
- [ ] `_ofwn_target_label`: 元投稿/固定ページのタイトル
- [ ] `_ofwn_requester`: 入力した依頼元
- [ ] `_ofwn_worker`: 入力した担当者
- [ ] `_ofwn_status`: 入力したステータス
- [ ] `_ofwn_work_date`: 入力した実施日（または今日の日付）
- [ ] `_ofwn_bound_post_id`: 元投稿/固定ページのID（数値）

### 元投稿/固定ページの確認項目
- [ ] `_ofwn_last_sync_hash`: 重複防止用ハッシュが保存される

## デバッグ確認

### WP_DEBUG_LOG有効時の確認
```
wp-content/debug.log に以下のようなログが出力される：
[OFWN] Auto-created work note ID: 123 for post ID: 45
```

### データベース直接確認（上級者用）
```sql
-- 作業メモCPT一覧
SELECT ID, post_title, post_date, post_content 
FROM wp_posts 
WHERE post_type = 'of_work_note' 
ORDER BY post_date DESC;

-- メタデータ確認
SELECT post_id, meta_key, meta_value 
FROM wp_postmeta 
WHERE meta_key LIKE '_ofwn_%' AND post_id IN (123);
```

## トラブルシューティング

### 作業メモCPTが作成されない場合
1. WP_DEBUG_LOGを有効にしてログを確認
2. 権限エラー：`current_user_can('edit_post')` を確認
3. メタデータ確認：右サイドバーの値が正しく保存されているか
4. フック実行確認：`save_post_post` / `save_post_page` が実行されているか

### 重複作成される場合
1. ハッシュ機能の動作確認
2. `_ofwn_last_sync_hash` メタの保存状況確認
3. キャッシュクリア後に再テスト

---

**テスト実施日**: ________  
**テスト実施者**: ________  
**結果**: [ ] 合格 / [ ] 不合格 (不合格の場合は詳細を記載)