# 作業メモ初期値流し込み機能 動作確認メモ

## テスト環境の準備

1. **既存作業メモの確認**
   - WordPress管理画面で「作業メモ」→「すべての作業メモ」を開く
   - 現在どの投稿/固定ページに作業メモが紐づいているか確認

2. **新規投稿/固定ページで初期値流し込みをテスト**

## テストケース1: 過去メモありのページ

### 手順
1. 既存の作業メモが紐づく投稿/固定ページを編集画面で開く
2. 右サイドバーの「作業メモ属性」パネルを確認
3. ブラウザのデベロッパーツール（F12）でコンソールを開く

### 期待結果
- コンソールに `Work Notes: 初期値を適用しました` のメッセージが表示される
- 以下のフィールドが最新の作業メモから自動入力される：
  - 対象タイプ: 「投稿/固定ページ」が選択済み
  - 対象ID: 現在の投稿IDが入力済み
  - 依頼元: 最新メモの依頼元が入力済み
  - 担当者: 最新メモの担当者が入力済み
- 対象ラベル: 空のまま
- ステータス: 「依頼」が選択済み
- 実施日: 今日の日付が入力済み

### スクリーンショット確認項目
- [ ] サイドバーに初期値が入力されている
- [ ] コンソールログが出力されている

## テストケース2: 過去メモなしのページ

### 手順
1. 新規投稿/固定ページを作成
2. 右サイドバーの「作業メモ属性」パネルを確認

### 期待結果
- 従来通りの動作（空フィールド + デフォルト値）
- 対象タイプ: 空
- 対象ID: 空
- 依頼元: 空
- 担当者: 空
- ステータス: 「依頼」
- 実施日: 今日の日付

## テストケース3: フォールバック→lazy backfill

### 手順
1. 古い作業メモ（`_ofwn_bound_post_id`が未設定）がある投稿を編集
2. ブラウザのデベロッパーツールでコンソールを確認

### 期待結果
- コンソールに `Work Notes: lazy backfill完了` のメッセージが表示
- データベースで該当作業メモに `_ofwn_bound_post_id` が付与されている

### 確認方法
```sql
-- WordPressデータベースで確認
SELECT post_id, meta_key, meta_value 
FROM wp_postmeta 
WHERE meta_key = '_ofwn_bound_post_id' 
ORDER BY post_id DESC;
```

## テストケース4: ユーザー編集後の上書き防止

### 手順
1. 初期値が適用された投稿で、依頼元フィールドを手動で変更
2. ページをリロード
3. 依頼元フィールドを確認

### 期待結果
- 手動で変更した値が保持されている（初期値で上書きされない）

## トラブルシューティング

### コンソールエラーが出る場合
- `wp.apiFetch is not defined`: REST APIの権限エラーの可能性
- `ofwnPrefill is not defined`: PHP側のlocalize_scriptが正常動作していない

### 初期値が適用されない場合
1. `window.ofwnPrefill` をコンソールで確認
2. 該当投稿に紐づく作業メモが存在するか確認
3. PHP側のクエリロジックをデバッグ

## 互換性確認

- [ ] Classic Editorで副作用がない
- [ ] 既存の作業メモ保存機能が正常動作
- [ ] 作業一覧ページが正常表示

## パフォーマンス確認

- [ ] 初期値取得クエリによる遅延がない（1秒以内）
- [ ] 大量作業メモ環境での動作確認

---

**実装完了日**: `date +%Y-%m-%d`  
**テスト実施者**: ________  
**結果**: [ ] 合格 / [ ] 不合格