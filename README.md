# work-notes
作業メモプラグイン
（このリポジトリは作業メモのためのWordPressプラグインです。）

---

<img width="1155" height="570" alt="image" src="https://github.com/user-attachments/assets/25df5376-536f-4970-9b54-d25ce85a0e98" />

---

## 📌 特徴
- ワードプレスの投稿や固定ページ、設定やテーマなんかを変更するときに、クライアントからの簡単な作業依頼書をつけたかった
- 作業依頼書といっても記載するのは作業者で、作業メモの様なものです
- いつ・誰が・どんな指示を出したから、この作業をいつ・どうしたかをワードプレス上で残すためのものです
<img width="1159" height="554" alt="image" src="https://github.com/user-attachments/assets/f4a55cdc-bfe4-49e3-9e07-cb4830667b5b" />

---

## 🚀 インストール方法
- 必要なファイルを wp-content/plugins/work-notes/ に配置
- またはZIPでアップロード
- その後、有効化

---

## 💻 使い方
- 「設定＞マスター管理」で依頼元/担当者を登録
- 「作業メモ」は各ページの最下部で記載
- 「作業一覧」これまでの作業一覧

---

## ⚙️ 動作環境
- WordPress 6.x
- PHP 7.4+（推奨8.1+）

---

## 📂 ディレクトリ構成
```
リポジトリ名/
├── work-notes.php
├── includes/
├───── admin-menu.php
├───── class-ofwn-list-table.php
├───── class-of-work-notes.php
├── assets/
├───── admin.css
├───── admin.js
├── uninstall.php
├── README.md         # このファイル
└── LICENSE           # ライセンスファイル
```

---

## 🔄 開発者向け

### Changelog自動更新
コミットメッセージからCHANGELOG.mdを自動更新するスクリプトが利用できます。

```bash
# 基本的な使用方法（今日の日付で未リリース版）
./update-changelog.sh

# 特定の日付・バージョンで更新
./update-changelog.sh "2025-08-13" "0.1.1"

# 特定の日付から未リリース版として更新
./update-changelog.sh "2025-08-10"
```

スクリプトは指定日付以降のコミットメッセージを取得し、CHANGELOG.mdに自動挿入します。

---

## 🔧 修正履歴・不具合対応レポート

### 2025-01-26: 管理画面一覧改善 + メタ保存バグ修正

#### 不具合原因
1. **ブロックエディタ対応不備**: register_post_meta による REST API 対応が欠落
2. **一覧列の不備**: 依頼元・担当者列が表示されていなかった
3. **ソート機能なし**: 管理画面でのカラムソートができなかった
4. **メタ保存の権限チェック不足**: Quick Edit での上書き対策やデバッグログなし
5. **本番環境での保存問題**: ブロックエディタからのメタ保存が失敗することがあった

#### 修正内容
1. **管理画面一覧の改善**
   - 依頼元（ofwn_requester）列を追加
   - 担当者（ofwn_assignee）列を追加（内部的には _ofwn_worker メタキーを使用）
   - 列の文字列ソート機能を実装
   
2. **ブロックエディタ対応強化**
   - register_post_meta で REST API 対応を追加
   - 全メタフィールドに show_in_rest=true を設定
   - 適切な権限チェック（auth_callback）を実装
   
3. **保存処理の改善**
   - 段階的なエラーハンドリング（ノンス、権限、投稿タイプチェック）
   - Quick Edit での意図しない上書きを防止
   - デバッグログ機能を追加（WP_DEBUG_LOG 有効時）
   - 保存前後の値検証ログ

#### 修正対象ファイル
- `includes/class-of-work-notes.php`: メイン機能改修

#### 再発防止策
- register_post_meta による確実なブロックエディタ対応
- デバッグログによる本番環境での問題追跡可能性向上
- Quick Edit チェックによる意図しない上書き防止

#### テスト手順
1. 新規作業メモ作成→保存→再編集で値が残ることを確認
2. 既存投稿の編集→保存→値が残ることを確認
3. ブロックエディタ・旧エディタ両方で動作確認
4. 管理画面一覧で依頼元・担当者列が表示され、ソートが動作することを確認
5. Quick Edit 時に値が勝手に消去されないことを確認
6. 本番・テスト両環境での再現テスト

---

## 📜 ライセンス
このプロジェクトは **MIT License** のもとで公開されています。  
詳細は [LICENSE](LICENSE) ファイルをご覧ください。


